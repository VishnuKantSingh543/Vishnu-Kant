<style>
  
  .v-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.35);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .v-modal.v-open {
    display: flex;
  }

  .v-modal-inner {
    background: #e9e9e9;
    width: 100%;
    max-width: 460px;
    padding: 24px;
    position: relative;
    font-family: 'Jost', sans-serif;
  }

  .v-close-btn {
    position: absolute;
    top: 14px;
    right: 14px;
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
  }

  .v-top-row {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
  }

  .v-image-wrapper img {
    width: 90%;
    height: 90%;
  }

  .v-info-wrapper h2 {
    font-family: 'Lustria', serif;
    font-size: 18px;
    margin: 0 0 6px 0;
    font-weight: 400;
  }

  .v-info-wrapper p {
    margin: 0 0 8px 0;
    font-size: 13px;
  }

  .v-options-section {
    width: 100%;
  }

  .v-option-group {
    margin-bottom: 16px;
  }

  .v-option-label {
    font-size: 12px;
    margin-bottom: 6px;
  }

  .v-option-values {
    display: flex;
    border: 1px solid #000;
  }

  .v-option-item {
  flex: 1;
  padding: 3% 5% !important;
  background: #fff;
  border: 1px solid black ;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  align-items: stretch; /* Change to stretch */
  justify-content: flex-start;
  gap: 0;
  position: relative;
  min-height: 44px;
  overflow: hidden;
}

/* .v-option-item span:not(.v-color-swatch) {
  padding: 0;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 44px; /* Match the button height */
/* } */

.v-option-text {
  padding: 12px;
  flex: 1;
  display: flex;
  align-items: center;
} */

  .v-option-item:not(:last-child) {
    border-right: 1px solid #000;
  }

  .v-option-item.v-selected {
    /* align-items: center; */
    background: #000;
    color: #fff;
  }

  .v-color-swatch {
    border-right: 1px solid white;
  width: 8px;
  height: 100%; /* ✅ Full height */
  position: absolute; /* ✅ Position absolutely */
  left: 0; /* ✅ Stick to left edge */
  top: 0;
  flex-shrink: 0;
}

  /* Dropdown for Size */
  .v-option-dropdown {
    font-family: 'Jost', sans-serif;
    font-size: 14px;
    font-weight: 300;
    padding: 12px 15px;
    background: #fff;
    border: 1px solid #ddd;
    cursor: pointer;
    width: 100%;
    color: #000;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23000' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    padding-right: 40px;
    
  }

  
.v-size-select {
  background-color: #fff;
  color: #000;
}

.v-size-select:focus {
  outline: none;
  border: 1px solid #000;
}

.v-size-select option {
  background: #000;
  color: #fff;
}


  .v-option-dropdown:focus {
    outline: none;
    border-color: #000;
  }

  .v-submit-btn {
    width: 100%;
    background: #000;
    color: #fff;
    border: none;
    padding: 14px;
    font-size: 13px;
    letter-spacing: 1px;
    cursor: pointer;
    margin-top: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
  }

  .v-no-scroll {
    overflow: hidden;
  }

  /* --- CUSTOM DROPDOWN STYLES --- */
  .custom-select-wrapper {
    position: relative;
    user-select: none;
    width: 100%;
    font-family: 'Jost', sans-serif;
    font-size: 14px;
    font-weight: 300;
  }

  .custom-select-trigger {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: #fff;
    border: 1px solid #ddd;
    cursor: pointer;
    color: #000;
  }

  .custom-options {
    position: absolute;
    display: none;
    top: 100%;
    left: 0;
    right: 0;
    border: 1px solid #000;
    border-top: none;
    background: #fff;
    z-index: 100;
    
    /* --- SCROLLABLE SETTINGS --- */
    max-height: 150px; /* Limits height to approx 4 items */
    overflow-y: auto;  /* Adds scrollbar if list is long */
  }

  .custom-options.open {
    display: block;
  }

  .custom-option-item {
    padding: 12px 15px;
    cursor: pointer;
    transition: all 0.2s;
    border-bottom: 1px solid #eee;
  }

  .custom-option-item:hover {
    background-color: #000; /* Black Hover */
    color: #fff; /* White Text */
  }
</style>

{% if product %}

  <!-- Hidden Product Data -->
  <div
    id="v-product-data-{{ block_id }}"
    data-title="{{ product.title | escape }}"
    data-price="{{ product.price }}"
    data-description="{{ product.description | strip_html | escape }}"
    data-image="{{ product.featured_image | image_url: width: 600 }}"
  ></div>

  <!-- Hidden Variant Data -->
  <div id="v-variant-container-{{ block_id }}" style="display:none;">
    {% for variant in product.variants %}
      <div
        class="v-variant-data"
        data-variant-id="{{ variant.id }}"
        data-available="{{ variant.available }}"
        {% for option in product.options %}
          data-{{ option | handle }}="{{ variant.options[forloop.index0] | escape }}"
        {% endfor %}
      ></div>
    {% endfor %}
  </div>

  <!-- POPUP MODAL -->
  <div id="v-popup-modal-{{ block_id }}" class="v-modal">
    <div class="v-modal-inner">

      <button onclick="closeVPopup('{{ block_id }}')" class="v-close-btn">×</button>

      <!-- Top Row -->
      <div class="v-top-row">
        <div class="v-image-wrapper">
          <img id="v-img-{{ block_id }}" src="" alt="">
        </div>

        <div class="v-info-wrapper">
          <h2 id="v-title-{{ block_id }}"></h2>
          <p id="v-price-{{ block_id }}"></p>
          <p id="v-desc-{{ block_id }}"></p>
        </div>
      </div>

      <!-- Options Section -->
      <div class="v-options-section">

        {% for option in product.options_with_values %}
          {% if option.name != 'Size' %}
            <div class="v-option-group">
              <p class="v-option-label">{{ option.name }}</p>
              
              <div class="v-option-values">
                {% for value in option.values %}
                  <button 
                    type="button"
                    class="v-option-item"
                    data-option-name="{{ option.name | handle }}"
                    data-option-value="{{ value | escape }}">
                    <span class="v-color-swatch" style="background-color: {{ value | downcase }};"></span>
                    {{ value }}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        {% for option in product.options_with_values %}
          {% if option.name == 'Size' %}
              <div class="v-option-group">
                <p class="v-option-label">{{ option.name }}</p>
                
                <div class="custom-select-wrapper">
                  
                  <select 
                    class="v-option-dropdown" 
                    style="display: none;" 
                    id="hidden-select-{{ block_id }}"
                    data-option-name="{{ option.name | handle }}">
                    <option value="">Choose your size</option>
                    {% for value in option.values %}
                      <option value="{{ value | escape }}">{{ value }}</option>
                    {% endfor %}
                  </select>

                  <div 
                    class="custom-select-trigger" 
                    onclick="toggleCustomSelect(this)">
                    <span class="custom-trigger-text">Choose your size</span>
                    <span style="font-size: 10px;">▼</span>
                  </div>

                  <div class="custom-options">
                    {% for value in option.values %}
                      <div 
                        class="custom-option-item" 
                        onclick="selectCustomSize(this, '{{ value | escape }}', '{{ block_id }}')">
                        {{ value }}
                      </div>
                    {% endfor %}
                  </div>

                </div>
              </div>
            {% endif %}
        {% endfor %}

        <form method="post" action="/cart/add">
          <input
            type="hidden"
            name="id"
            id="v-variant-input-{{ block_id }}"
            value="{{ product.variants.first.id }}"
          >

          <button type="submit" class="v-submit-btn">
            ADD TO CART <span>→</span>
          </button>
        </form>

      </div>

    </div>
  </div>

  <script>
    // Toggle the custom list open/close
    function toggleCustomSelect(trigger) {
      const wrapper = trigger.closest('.custom-select-wrapper');
      const options = wrapper.querySelector('.custom-options');
      
      // Close all other open dropdowns first
      document.querySelectorAll('.custom-options').forEach(el => {
        if(el !== options) el.classList.remove('open');
      });

      options.classList.toggle('open');
    }

    // Handle clicking an option
    function selectCustomSize(item, value, blockId) {
      const wrapper = item.closest('.custom-select-wrapper');
      
      // 1. Update the hidden <select> so existing logic works
      const hiddenSelect = wrapper.querySelector('select.v-option-dropdown');
      hiddenSelect.value = value;
      
      // 2. Trigger change event manually for updateVariant()
      hiddenSelect.dispatchEvent(new Event('change')); // This runs your existing 'updateVariant' function

      // 3. Update the visual text
      wrapper.querySelector('.custom-trigger-text').innerText = value;
      
      // 4. Close the dropdown
      wrapper.querySelector('.custom-options').classList.remove('open');
    }

    // Close dropdown if clicking anywhere else
    window.addEventListener('click', function(e) {
      if (!e.target.closest('.custom-select-wrapper')) {
        document.querySelectorAll('.custom-options').forEach(el => el.classList.remove('open'));
      }
    });

    
    function openVPopup(e, blockId) {
      e.stopPropagation();

      const productData = document.getElementById('v-product-data-' + blockId);

      document.getElementById('v-title-' + blockId).innerText = productData.dataset.title;
      document.getElementById('v-price-' + blockId).innerText = (productData.dataset.price / 100).toFixed(2) + ' €';
      document.getElementById('v-desc-' + blockId).innerText = productData.dataset.description;
      document.getElementById('v-img-' + blockId).src = productData.dataset.image;

      document.getElementById('v-popup-modal-' + blockId).classList.add('v-open');
      document.body.classList.add('v-no-scroll');

      // Auto-select first color option if available
      // const popup = document.getElementById('v-popup-modal-' + blockId);
      // const firstColorButton = popup.querySelector('.v-option-item');
      // if (firstColorButton) {
      //   firstColorButton.classList.add('v-selected');
      //   updateVariant(blockId);
      // }
    }

    function closeVPopup(blockId) {
      const modal = document.getElementById('v-popup-modal-' + blockId);
      if (!modal) return;
      modal.classList.remove('v-open');
      document.body.classList.remove('v-no-scroll');
    }

    function handleDropdownChange(selectElement, blockId) {
      updateVariant(blockId);
    }

    function updateVariant(blockId) {
      const popup = document.getElementById('v-popup-modal-' + blockId);
      const selectedOptions = {};

      // Get selected button options (Color)
      popup.querySelectorAll('.v-option-item.v-selected').forEach(button => {
        selectedOptions[button.dataset.optionName] = button.dataset.optionValue;
      });

      // Get selected dropdown options (Size)
      popup.querySelectorAll('.v-option-dropdown').forEach(dropdown => {
        if (dropdown.value) {
          selectedOptions[dropdown.dataset.optionName] = dropdown.value;
        }
      });

      // ✅ FIX 1: Get all variants - this was missing!
      const variants = document.querySelectorAll('#v-variant-container-' + blockId + ' .v-variant-data');
      
      let matchedVariant = null;

      variants.forEach((variant) => {
        // ✅ FIX 2: Skip if we already found a match
        if (matchedVariant) return;
        
        let match = true;

        for (const key in selectedOptions) {
          if (variant.dataset[key] !== selectedOptions[key]) {
            match = false;
            break; // ✅ FIX 3: Stop checking if one option doesn't match
          }
        }

        if (match && variant.dataset.available === 'true') {
          matchedVariant = variant;
        }
      });

      // Update the variant input with the matched variant
      if (matchedVariant) {
        document.getElementById('v-variant-input-' + blockId).value = matchedVariant.dataset.variantId;
        
        // ✅ BONUS: Debug logging (you can remove these console.log lines later)
        console.log('✅ Selected:', selectedOptions, '→ Variant ID:', matchedVariant.dataset.variantId);
      } else {
        console.log('❌ No match found for:', selectedOptions);
      }
    }

    document.addEventListener('click', function (e) {
      if (!e.target.classList.contains('v-option-item')) return;

      const button = e.target;
      const popup = button.closest('.v-modal');
      const blockId = popup.id.replace('v-popup-modal-', '');
      const optionName = button.dataset.optionName;

      // Remove selection only inside this popup
      popup.querySelectorAll(`[data-option-name="${optionName}"]`).forEach((el) => {
        el.classList.remove('v-selected');
      });

      button.classList.add('v-selected');
      updateVariant(blockId);
    });
  </script>
{% endif %}