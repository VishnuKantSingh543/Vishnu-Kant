
<div id="v-popup-modal" class="v-overlay" onclick="closeVPopup()">
  <div class="v-popup-box" onclick="event.stopPropagation()">
    <button class="v-close-icon" type="button" onclick="closeVPopup()" aria-label="Close">×</button>

    <div class="v-layout-flex">
      <div class="v-col-left" id="v-img-border">
        <img id="v-img" src="" alt="Product Image">
      </div>

      <div class="v-col-right">
        <h3 id="v-title" class="v-item-title"></h3>
        <p id="v-price" class="v-item-price"></p>
        <div id="v-desc" class="v-item-desc"></div>
      </div>
    </div>

    <div id="v-form-container">
      <div class="v-group-wrapper" id="v-group-2" style="display:none;">
        <label class="v-group-label" id="v-label-2"></label>
        <div id="v-swatch-list" class="v-swatch-container"></div>
      </div>

      <div class="v-group-wrapper" id="v-group-1" style="display:none;">
        <label class="v-group-label" id="v-label-1">Size</label>
        <div class="v-custom-dropdown" id="v-dropdown-parent">
          <div class="v-dropdown-header" onclick="toggleVDropdown()">
            <span id="v-selected-text">Choose your size</span>
            <div class="v-dropdown-arrow-box">
              <svg id="v-arrow-icon" width="14" height="8" viewBox="0 0 14 8" fill="none">
                <path d="M1 1L7 7L13 1" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="v-dropdown-list" id="v-dropdown-list"></div>
        </div>
      </div>
    </div>

    <button class="v-cart-btn" id="v-submit-btn">ADD TO CART <span>→</span></button>
  </div>
</div>

<style>
    body.v-no-scroll {
    overflow: hidden !important;
    height: 100vh;
  }
  /* --- Modal & Overlay --- */
  .v-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  .v-overlay.v-open {
    display: flex !important;
  }

  .v-popup-box {
    background: #fff;
    padding: 25px;
    width: 380px;
    max-width: 95%;
    position: relative;
    border: 1px solid #eee;
    max-height: 90vh;
    overflow-y: visible; 
  }

  .v-layout-flex {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    margin-bottom: 20px;
  }
  .v-col-left {
    flex: 0 0 45%;
  }
  .v-col-left img {
    width: 100%;
    height: auto;
    display: block;
    border: 1px solid #eee;
  }
  .v-col-right {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  
  .v-item-title {
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    font-size: 20px;
    margin: 0;
    color: #333;
  }
  .v-item-price {
    font-family: 'Jost', sans-serif;
    font-size: 18px;
    margin: 10px 0;
    color: #000;
    font-weight: 400;
  }
  .v-item-desc {
    font-family: 'Jost', sans-serif;
    font-size: 13px;
    line-height: 1.4;
    color: #555;
  }

 
  .v-swatch-container {
    display: flex;
    border: 1px solid #000;
    width: 100%;
    overflow: hidden;
    margin-top: 5px;
  }
  .v-swatch-item {
    flex: 1;
    padding: 12px;
    text-align: left;
    cursor: pointer;
    font-size: 15px;
    background: #fff;
    display: flex;
    align-items: center;
    position: relative;
    border-right: 1px solid white !important;
  }
  .v-swatch-item:last-child {
    border-right: none !important;
  }
  .v-swatch-bar {
    width: 6px;
    height: 100%;
    position: absolute;
    left: 0;
    top: 0;
    border-right: 1px solid white !important;
  }
  .v-swatch-text {
    padding-left: 20px;
    flex: 1;
  }
  .v-swatch-item.v-active {
    background: #000 !important;
    color: #fff !important;
  }

 
  .v-custom-dropdown {
    width: 100%;
    position: relative;
    font-family: 'Jost', sans-serif;
    margin-top: 5px;
  }
  .v-dropdown-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #000;
    cursor: pointer;
    height: 48px;
    padding-left: 15px;
    background: #fff;
  }
  .v-dropdown-arrow-box {
    width: 48px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-left: 1px solid #000;
  }

  
  .v-dropdown-list {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    background: #fff;
    border: 1px solid #000;
    border-top: none;
    display: none;
    z-index: 50;
    max-height: 150px; 
    overflow-y: auto;
  }

  #v-dropdown-parent.v-open .v-dropdown-list {
    display: block;
  }
  #v-dropdown-parent.v-open #v-arrow-icon {
    transform: rotate(180deg);
  }

  .v-option-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: 0.1s;
    text-align: center;
    font-size: 15px;
  }
  .v-option-item:last-child {
    border-bottom: none;
  }
  .v-option-item:hover,
  .v-option-item.v-selected {
    background: #000;
    color: #fff;
  }

 
  .v-group-wrapper {
    width: 100%;
    margin-bottom: 15px;
  }
  .v-group-label {
    display: block;
    font-size: 12px;
    font-weight: 400;
    color: #666;
    margin-bottom: 5px;
  }
  .v-cart-btn {
    width: 100%;
    background: #000;
    color: #fff;
    border: none;
    padding: 18px;
    font-weight: 400;
    text-transform: uppercase;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    letter-spacing: 1px;
    font-size: 14px;
    margin-top: 10px;
  }
  .v-cart-btn span {
    font-size: 22px;
    line-height: 1;
  }
  .v-close-icon {
    position: absolute;
    top: 1%;
    right: 1%;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #333;
    z-index: 60;
  }

  @media (max-width: 768px) {
    .v-layout-flex {
      flex-direction: column;
      gap: 15px;
    }
    .v-col-left,
    .v-col-right {
      width: 100%;
    }
  }
</style>

<script>
  let currentProductData = null;
  let selectedColor = '';
  let selectedSize = '';

  function toggleVDropdown() {
    document.getElementById('v-dropdown-parent').classList.toggle('v-open');
  }

  function openVPopup(e, blockId) {
    e.stopPropagation();
    const dataElement = document.getElementById('v-data-' + blockId);
    if (!dataElement) return;

    currentProductData = JSON.parse(dataElement.textContent);

    document.getElementById('v-title').innerText = currentProductData.title;
    document.getElementById('v-price').innerText = (currentProductData.price / 100).toFixed(2).replace('.', ',') + '€';
    document.getElementById('v-desc').innerText = currentProductData.description;
    document.getElementById('v-img').src = currentProductData.featured_image;

    selectedSize = '';
    document.getElementById('v-selected-text').innerText = 'Choose your size';
    document.getElementById('v-dropdown-parent').classList.remove('v-open');
    document.getElementById('v-swatch-list').innerHTML = '';
    document.getElementById('v-dropdown-list').innerHTML = '';

    currentProductData.options.forEach((opt, i) => {
      const name = opt.name.toLowerCase();

      if (name === 'color' || name === 'colour') {
        opt.values.forEach((val, idx) => {
          const item = document.createElement('div');
          item.className = 'v-swatch-item' + (idx === 0 ? ' v-active' : '');
          item.innerHTML = `<span class="v-swatch-bar" style="background-color:${val.toLowerCase()}"></span><span class="v-swatch-text">${val}</span>`;
          if (idx === 0) selectedColor = val;
          item.onclick = function () {
            document.querySelectorAll('.v-swatch-item').forEach((el) => el.classList.remove('v-active'));
            this.classList.add('v-active');
            selectedColor = val;
          };
          document.getElementById('v-swatch-list').appendChild(item);
        });
        document.getElementById('v-group-2').style.display = 'block';
      } else if (name === 'size') {
        opt.values.forEach((val) => {
          const optDiv = document.createElement('div');
          optDiv.className = 'v-option-item';
          optDiv.innerText = val;
          optDiv.onclick = function () {
            selectedSize = val;
            document.getElementById('v-selected-text').innerText = val;
            document.querySelectorAll('.v-option-item').forEach((el) => el.classList.remove('v-selected'));
            this.classList.add('v-selected');
            toggleVDropdown();
          };
          document.getElementById('v-dropdown-list').appendChild(optDiv);
        });
        document.getElementById('v-group-1').style.display = 'block';
      }
    });

    document.getElementById('v-submit-btn').onclick = handleAddToCart;
    document.getElementById('v-popup-modal').classList.add('v-open');
    document.body.classList.add('v-no-scroll');
  }

  function closeVPopup() {
    document.getElementById('v-popup-modal').classList.remove('v-open');
    document.body.classList.remove('v-no-scroll');
  }

  async function handleAddToCart() {
    let selection = [];
    currentProductData.options.forEach((opt) => {
      if (opt.name.toLowerCase().includes('color')) selection.push(selectedColor);
      if (opt.name.toLowerCase() === 'size') selection.push(selectedSize);
    });

    
    const variant = currentProductData.variants.find((v) => JSON.stringify(v.options) === JSON.stringify(selection));

    if (variant) {
      document.getElementById('v-submit-btn').innerText = 'ADDING...';

     
      let itemsToAdd = [{ id: variant.id, quantity: 1 }];

      
      if (selectedColor === 'Black' && selectedSize === 'M') {
        
       
        const giftVariantId = 51378223022401; 
        
        itemsToAdd.push({ id: giftVariantId, quantity: 1 });
      }
      

      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: itemsToAdd }),
        });
        if (response.ok) window.location.href = '/cart';
      } catch (err) {
        console.error('Cart error:', err);
      }
    } else {
      alert('Please select a size.');
    }
  }
</script>
